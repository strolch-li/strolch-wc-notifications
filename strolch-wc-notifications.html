<!-- Components -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../strolch-wc-styles/strolch-wc-app-style.html">
<link rel="import" href="../strolch-wc-util-behavior/strolch-wc-component-behavior.html">
<link rel="import" href="../strolch-wc-raw-text/strolch-wc-raw-text.html">
<link rel="import" href="../strolch-wc-date-time/strolch-wc-date-picker.html">
<link rel="import" href="../strolch-wc-date-time/strolch-wc-editable-time-picker.html">

<link rel="import" href="./strolch-wc-notification-detail.html">
<link rel="import" href="./strolch-wc-notification.html">

<dom-module id="strolch-wc-notifications">
    <template>
        <!-- Style -->
        <style is="custom-style" include="strolch-wc-app-style">
            :host {

            }

            .content {
                display: flex;
                flex-direction: column;
            }

            textarea {
                padding: 8px;
                margin: 8px;
                width: calc(100% - 32px);
                min-height: 200px;
            }

            paper-card {
                padding: 8px;
            }

            textarea {
                width: calc(100% - 96px);
                margin: 0 24px;
            }

            div.visibility {
                margin-top: 0;
            }
            p.visibility {
                margin-top: 0;
            }
            .inline-blk {
                display: inline-block;
            }
        </style>

        <!-- Content -->
        <template is="dom-if" if="[[testNotification]]">
            <strolch-wc-notification message="[[testNotification.title]]" action1="[[localize('details')]]"
                                     callback1="[[testNotification.callback1]]"
                                     bind="[[testNotification.bind]]"
                                     fa-icon="[[testNotification.faIcon]]"></strolch-wc-notification>
        </template>
        <div class="actions padding actions-right">
            <div>
                <paper-button on-tap="onAddNotification" raised>
                    [[localize('add')]]
                </paper-button>
                <paper-icon-button on-tap="refresh" icon="refresh"></paper-icon-button>
            </div>
        </div>
        <div id="content" class="content">
            <template is="dom-repeat" items="[[notifications]]" as="notification">
                <paper-card raised="1">
                    <h3>[[notification.title]]</h3>
                    <strolch-wc-raw-text text="[[notification.text]]"></strolch-wc-raw-text>
                    <!--                    <textarea class="form-control" readonly type="text" value="{{notification.text::input}}"></textarea>-->
                    <!--                    <paper-textarea value="[[notification.text]]"></paper-textarea>-->
                    <p>[[localize('validFrom')]]: [[formatDateTimeDashIfEmpty(notification.visibleFrom)]]</p>
                    <p>[[localize('validTo')]]: [[formatDateTimeDashIfEmpty(notification.visibleTo)]]</p>
                    <div class="actions padding actions-right">
                        <div>
                            <paper-button on-tap="onTestNotification" raised>
                                [[localize('test')]]
                            </paper-button>
                            <paper-button on-tap="onEditNotification" raised>
                                [[localize('edit')]]
                            </paper-button>
                        </div>
                    </div>
                </paper-card>
            </template>
        </div>

        <paper-dialog id="editDlg" modal on-iron-overlay-closed="close">
            <iron-a11y-keys keys="esc" on-keys-pressed="close"></iron-a11y-keys>
            <paper-input label="[[localize('title')]]" value="{{editNotification.title}}"></paper-input>
            <p>[[localize('text')]]:</p>
            <textarea rows="8">{{editNotification.text::input}}</textarea>
            <p class="visibility">[[localize('textWithSimpleHtmlTagsAllowed')]]</p>

            <div class="visibility">
                <strolch-wc-date-picker class="inline-blk" id="startDate" label="[[localize('visibleFrom')]]"
                                        value="{{editNotification.visibleDateFrom}}"></strolch-wc-date-picker>
                <strolch-wc-editable-time-picker class="inline-blk" id="startTime" label="[[localize('time')]]" increments="30"
                                                 value="{{editNotification.visibleTimeFrom}}"></strolch-wc-editable-time-picker>
            </div>
            <div>
                <strolch-wc-date-picker class="inline-blk" id="endDate" label="[[localize('visibleTo')]]"
                                        value="{{editNotification.visibleDateTo}}"></strolch-wc-date-picker>
                <strolch-wc-editable-time-picker class="inline-blk" id="endTime" label="[[localize('time')]]" increments="30"
                                                 value="{{editNotification.visibleTimeTo}}"></strolch-wc-editable-time-picker>
            </div>

            <div class="buttons">
                <paper-button dialog-dismiss>[[localize('cancel')]]</paper-button>
                <paper-button autofocus on-tap="onSaveNotification">[[localize('save')]]</paper-button>
            </div>
        </paper-dialog>

        <strolch-wc-notification-detail id="detailDlg" base-path="../"
                                        base-rest-path="[[baseRestPath]]"
                                        locales-path="[[localesPath]]"></strolch-wc-notification-detail>

        <!-- ajax request -->
        <iron-ajax id="ajaxGetNotifications" url="[[baseRestPath]]/strolch/notifications"
                   content-type="application/json" handle-as="json" method="GET"
                   on-response="onGetNotificationsResponse" on-error="onAjaxError"
                   loading="{{loadingGetReports}}"></iron-ajax>

    </template>

    <script>
        Polymer({
            <!-- Settings -->
            is: "strolch-wc-notifications",

            <!-- Behaviors -->
            behaviors: [
                StrolchComponentBehavior
            ],

            <!-- Properties -->
            properties: {
                toolbarConfig: {
                    type: Object,
                    value: {
                        pageTitle: "notifications",
                        backButton: true,
                        searchInput: false,
                        lockLocation: false
                    },
                    notify: true,
                    readOnly: true
                },
                notifications: {
                    type: Array
                },
                testNotification: {
                    type: Object
                }
            },

            <!-- Functions -->
            reload: function () {
                this.refresh();
            },
            refresh: function () {
                this.$.ajaxGetNotifications.generateRequest();
            },

            onAddNotification: function (e) {

            },
            onEditNotification: function (e) {
                var notification = JSON.parse(JSON.stringify(e.model.notification));
                notification.visibleDateFrom = new Date(notification.visibleFrom);
                notification.visibleDateTo = new Date(notification.visibleTo);
                var s = notification.visibleFrom;
                notification.visibleTimeFrom = s.substring(s.indexOf("T") + 1).substring(0, 5);
                s = notification.visibleTo;
                notification.visibleTimeTo = s.substring(s.indexOf("T") + 1).substring(0, 5);

                this.editNotification = notification;
                this.$.editDlg.open();
            },
            onTestNotification: function (e) {
                var notification = e.model.notification;
                notification.callback1 = function () {
                    this.showDetail(notification);
                }.bind(this);
                this.testNotification = notification;
                this.async(function () {
                    this.testNotification = null;
                }, 10000);
            },
            showDetail: function (notification) {
                this.$.detailDlg.open(notification);
            },

            ready: function () {

            },

            onGetNotificationsResponse: function (e) {
                this.notifications = e.detail.response.data;
            }

        });
    </script>
</dom-module>
