<!-- Components -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../strolch-wc-styles/strolch-wc-app-style.html">
<link rel="import" href="../strolch-wc-util-behavior/strolch-wc-component-behavior.html">
<link rel="import" href="../strolch-wc-raw-text/strolch-wc-raw-text.html">
<link rel="import" href="../strolch-wc-date-time/strolch-wc-date-picker.html">
<link rel="import" href="../strolch-wc-date-time/strolch-wc-editable-time-picker.html">

<link rel="import" href="./strolch-wc-notifications-behavior.html">
<link rel="import" href="./strolch-wc-notification-edit-dlg.html">
<link rel="import" href="./strolch-wc-notification-detail.html">
<link rel="import" href="./strolch-wc-notification.html">

<dom-module id="strolch-wc-notifications">
    <template>
        <!-- Style -->
        <style is="custom-style" include="strolch-wc-app-style">
            :host {

            }

            .content {
                display: flex;
                flex-direction: column;
            }

            textarea {
                padding: 8px;
                min-height: 200px;
                width: calc(100% - 96px);
                margin: 0 24px;
            }

            paper-card {
                padding: 8px;
            }


        </style>

        <!-- Content -->
        <template is="dom-if" if="[[testNotification]]">
            <strolch-wc-notification message="[[testNotification.title]]" action1="[[localize('details')]]"
                                     callback1="[[testNotification.callback1]]"
                                     bind="[[testNotification.bind]]"
                                     fa-icon="[[testNotification.faIcon]]"></strolch-wc-notification>
        </template>
        <div class="actions padding actions-right">
            <div>
                <paper-button on-tap="onAddNotification" raised>
                    [[localize('add')]]
                </paper-button>
                <paper-icon-button on-tap="refresh" icon="refresh"></paper-icon-button>
            </div>
        </div>
        <div id="content" class="content">
            <template is="dom-repeat" items="[[notifications]]" as="notification">
                <paper-card raised="1">
                    <template is="dom-repeat" items="[[supportedLanguages]]" as="language">
                        <h2>[[language.name]]</h2>

                        <h3>[[notification.title]]</h3>
                        <strolch-wc-raw-text text="[[notification.text]]"></strolch-wc-raw-text>
                        <!--                    <textarea class="form-control" readonly type="text" value="{{notification.text::input}}"></textarea>-->
                        <!--                    <paper-textarea value="[[notification.text]]"></paper-textarea>-->
                        <p>[[localize('validFrom')]]: [[formatDateTimeDashIfEmpty(notification.visibleFrom)]]</p>
                        <p>[[localize('validTo')]]: [[formatDateTimeDashIfEmpty(notification.visibleTo)]]</p>
                        <div class="actions padding actions-right">
                            <div>
                                <paper-button on-tap="onTestNotification" raised>
                                    [[localize('test')]]
                                </paper-button>
                                <paper-button on-tap="onEditNotification" raised>
                                    [[localize('edit')]]
                                </paper-button>
                            </div>
                        </div>
                    </template>
                </paper-card>
            </template>
        </div>

        <strolch-wc-notification-edit-dlg id="editDlg" supported-languages="[[supportedLanguages]]" base-path="../"
                                          base-rest-path="[[baseRestPath]]"
                                          locales-path="[[localesPath]]"></strolch-wc-notification-edit-dlg>
        <strolch-wc-notification-detail id="detailDlg" base-path="../"
                                        base-rest-path="[[baseRestPath]]"
                                        locales-path="[[localesPath]]"></strolch-wc-notification-detail>

        <!-- ajax request -->
        <iron-ajax id="ajaxGetSupportedLanguages" url="[[baseRestPath]]/strolch/languages/supported"
                   content-type="application/json" handle-as="json" method="GET"
                   on-response="onGetSupportedLanguagesResponse" on-error="onRequestError"></iron-ajax>
        <iron-ajax id="ajaxGetAllNotifications" url="[[baseRestPath]]/strolch/notifications/all"
                   content-type="application/json" handle-as="json" method="GET"
                   on-response="onGetAllNotificationsResponse" on-error="onRequestError"></iron-ajax>
        <iron-ajax id="ajax" content-type="application/json" handle-as="json" on-response="onAjaxResponse"
                   on-error="onRequestError"></iron-ajax>

    </template>

    <script>
        Polymer({
            <!-- Settings -->
            is: "strolch-wc-notifications",

            <!-- Behaviors -->
            behaviors: [
                StrolchNotificationsBehavior
            ],

            <!-- Properties -->
            properties: {
                toolbarConfig: {
                    type: Object,
                    value: {
                        pageTitle: "notifications",
                        backButton: true,
                        searchInput: false,
                        lockLocation: false
                    },
                    notify: true,
                    readOnly: true
                },
                supportedLanguages: {
                    type: Array
                },
                notifications: {
                    type: Array
                },
                testNotification: {
                    type: Object
                }
            },

            <!-- Functions -->
            reload: function () {
                this.refresh();
            },
            refresh: function () {
                this.$.ajaxGetSupportedLanguages.generateRequest();
                this.$.ajaxGetAllNotifications.generateRequest();
            },

            onAddNotification: function (e) {

            },
            onEditNotification: function (e) {
                this.$.editDlg.open(e.model.notification);
            },
            showDetail: function (notification) {
                this.$.detailDlg.open(notification);
            },
            onTestNotification: function (e) {
                var notification = e.model.notification;
                notification.callback1 = function () {
                    this.showDetail(notification);
                }.bind(this);
                this.testNotification = notification;
                this.async(function () {
                    this.testNotification = null;
                }, 10000);
            },

            ready: function () {

            },

            onGetAllNotificationsResponse: function (e) {
                this.notifications = e.detail.response.data;
            },
            onGetSupportedLanguagesResponse: function (e) {
                this.supportedLanguages = e.detail.response;
                this.selectedLanguageTab = this.supportedLanguages[0].locale;
            },
            onSaveNotification: function (e) {
                var notification = this.editNotification;

                this.$.ajax.url = this.baseRestPath + '/strolch/notifications/' + notification.id;
                this.$.ajax.method = 'PUT';
                this.$.ajax.body = notification;
                this.$.ajax.onResponse = this.closeEditDlg;
                this.$.ajax.generateRequest();
            }
        });
    </script>
</dom-module>
